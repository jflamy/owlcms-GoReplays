<!DOCTYPE html>
<html>
<head>
    <title>Video Files</title>
    <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
    <script type="text/javascript">
        let ws;
        
        function updateStatusMessage(text, code) {
            const statusDiv = document.getElementById('status-message');
            if (statusDiv) {
                // Clear any existing content
                statusDiv.textContent = text || '';
                
                // Reset classes and add new ones
                statusDiv.className = 'status-message';  // Always keep base class
                if (text) {
                    switch (code) {
                        case 0:
                            statusDiv.classList.add('ready');
                            break;
                        case 1:
                            statusDiv.classList.add('recording');
                            break;
                        case 2:
                            statusDiv.classList.add('trimming');
                            break;
                        case 3:
                            statusDiv.classList.add('error');
                            break;
                    }
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.style.display = 'none';
                }
                console.log('Status updated:', text, 'code:', code);
            }
        }

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws`);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
            };

            ws.onmessage = function(event) {
                console.log('Received:', event.data);
                try {
                    const msg = JSON.parse(event.data);
                    if (msg && typeof msg.text === 'string') {
                        updateStatusMessage(msg.text, msg.code);
                        
                        // Only reload when new videos are ready, not for the "Total videos available" message
                        if (msg.code === 0 && 
                            msg.text.includes('Videos ready') && 
                            !msg.text.includes('Total videos available')) {
                            console.log('Reloading page due to new videos');
                            setTimeout(() => location.reload(), 1000);
                        }
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            ws.onclose = function() {
                console.log('WebSocket closed, reconnecting...');
                setTimeout(connectWebSocket, 1000);
            };
        }

        // Start connection when page loads
        window.addEventListener('load', connectWebSocket);
    </script>
</head>
<body>
    <h1>Replays</h1>
    
    {{if .NoSessions}}
        <div class="no-sessions">No recorded sessions</div>
    {{else}}
        <div class="session-container">
            <span class="current-session">{{if .ActiveSession}}Current Session: {{.ActiveSession}}{{else}}No active session{{end}}</span>
            <select class="session-selector" onchange="window.location.href='/?session=' + this.value">
                <option value="" disabled {{if not .SelectedSession}}selected{{end}}>Select Session</option>
                {{range .Sessions}}
                    <option value="{{.}}" {{if eq . $.SelectedSession}}selected{{end}}>{{.}}</option>
                {{end}}
            </select>
        </div>
    {{end}}
    
    <div id="status-message" class="status-message"></div>

    <ul>
        {{range .Videos}}
            <li><a href="/videos/{{.Filename}}" target="_blank" rel="noopener noreferrer">{{.DisplayName}}</a></li>
        {{end}}
    </ul>
</body>
</html>
